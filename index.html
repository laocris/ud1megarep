<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ejercicio de Chino B√°sico</title>
<style>
    body {
        font-family: 'Noto Sans SC', Arial, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        min-height: 100vh;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,0,0,.03) 35px, rgba(255,0,0,.03) 70px),
            repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255,0,0,.03) 35px, rgba(255,0,0,.03) 70px);
        pointer-events: none;
        z-index: -1;
    }

    .nivel {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 2px solid #e74c3c;
        position: relative;
        display: none;
    }

    .nivel.activo {
        display: block;
    }

    .nivel::before {
        content: '';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 20px;
        background: #e74c3c;
        border-radius: 50px;
    }

    h2 {
        text-align: center;
        color: #c0392b;
        font-size: 28px;
        margin-bottom: 30px;
        font-weight: 700;
    }

    .progreso {
        background: #f8f8f8;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        border: 1px solid #e74c3c;
    }

    .progreso-texto {
        color: #c0392b;
        font-weight: 600;
        font-size: 18px;
    }

    .traduccion {
        background: #fff9f9;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
        font-style: italic;
        color: #7f8c8d;
        border: 1px solid #f5b7b1;
    }

    .caracteres-container {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        margin: 30px 0;
        justify-content: center;
    }

    .caracter-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100px;
        text-align: center;
    }

    .caracter {
        font-size: 36px;
        padding: 15px;
        background: linear-gradient(145deg, #fff, #f8f8f8);
        border: 2px solid #e74c3c;
        border-radius: 10px;
        margin-bottom: 10px;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        font-weight: 700;
        color: #2c3e50;
    }

    .pinyin-slot {
        width: 80px;
        height: 40px;
        border: 3px dashed #e74c3c;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff9f9;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .pinyin-slot:hover {
        border-color: #c0392b;
        background: #fff5f5;
    }

    .pinyin-slot.correcto {
        background: #d5f4e6;
        border-color: #27ae60;
        color: #27ae60;
        font-weight: 600;
        cursor: pointer;
    }

    .pinyin-slot.correcto:hover {
        background: #c8f0db;
        transform: scale(1.05);
    }

    .pinyin {
        padding: 8px 15px;
        background: #e74c3c;
        color: white;
        border-radius: 20px;
        cursor: move;
        user-select: none;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
    }

    .pinyin:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
    }

    .pinyin.usado {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pinyin-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 30px 0;
        padding: 20px;
        background: linear-gradient(145deg, #fff5f5, #ffebeb);
        border-radius: 10px;
        border: 1px solid #f5b7b1;
        justify-content: center;
        min-height: 80px;
    }

    .zona-frase {
        min-height: 120px;
        padding: 25px;
        background: linear-gradient(145deg, #fff5f5, #ffebeb);
        border: 2px solid #e74c3c;
        border-radius: 15px;
        margin: 30px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        justify-content: center;
    }

    .caracter-completo {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: white;
        padding: 15px;
        border: 2px solid #e74c3c;
        border-radius: 10px;
        cursor: move;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .caracter-completo:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .caracter-completo.colocado {
        cursor: pointer;
    }

    .caracter-completo.colocado:hover {
        background: #ffe0e0;
        transform: scale(1.05);
    }

    .caracter-completo .hanzi {
        font-size: 32px;
        margin-bottom: 5px;
        font-weight: 700;
        color: #2c3e50;
    }

    .caracter-completo .pinyin {
        background: none;
        color: #e74c3c;
        box-shadow: none;
        padding: 5px;
        font-size: 14px;
    }

    .dialogo-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .dialogo-frases {
        background: linear-gradient(145deg, #fff5f5, #ffebeb);
        border: 2px solid #e74c3c;
        border-radius: 15px;
        padding: 20px;
    }

    .dialogo-orden {
        background: #f8f8f8;
        border: 2px solid #e74c3c;
        border-radius: 15px;
        padding: 20px;
    }

    .dialogo-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        border: 2px solid #e74c3c;
        cursor: move;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .dialogo-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .dialogo-item.en-slot {
        cursor: pointer;
    }

    .dialogo-item.en-slot:hover {
        background: #ffe0e0;
        transform: scale(1.02);
    }

    .dialogo-texto {
        font-size: 20px;
        color: #2c3e50;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .dialogo-traduccion {
        font-size: 14px;
        color: #7f8c8d;
        font-style: italic;
    }

    .dialogo-slot {
        min-height: 80px;
        background: white;
        border: 3px dashed #e74c3c;
        border-radius: 10px;
        margin: 15px 0;
        padding: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .dialogo-slot::before {
        content: attr(data-numero);
        position: absolute;
        top: -15px;
        left: 10px;
        background: #e74c3c;
        color: white;
        padding: 2px 10px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: 600;
    }

    .dialogo-slot.lleno {
        border-style: solid;
        background: #fff9f9;
    }

    .botones-control {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    button {
        padding: 15px 40px;
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        transition: all 0.3s ease;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    button:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .btn-secundario {
        background: linear-gradient(145deg, #95a5a6, #7f8c8d);
        padding: 12px 30px;
        font-size: 16px;
    }

    .btn-secundario:hover {
        box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
    }

    .btn-deshacer {
        background: linear-gradient(145deg, #3498db, #2980b9);
    }

    .btn-deshacer:hover {
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    .instruccion {
        background: linear-gradient(145deg, #fff5f5, #ffebeb);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
        font-size: 20px;
        color: #c0392b;
        border: 1px solid #f5b7b1;
    }

    .mensaje-feedback {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 1000;
        text-align: center;
        display: none;
        border: 3px solid #e74c3c;
        max-width: 400px;
    }

    .mensaje-feedback.exito {
        border-color: #27ae60;
    }

    .mensaje-feedback h3 {
        margin: 0 0 20px 0;
        font-size: 28px;
        color: #2c3e50;
    }

    .mensaje-feedback p {
        margin: 0 0 20px 0;
        font-size: 18px;
        color: #7f8c8d;
    }

    .mensaje-feedback button {
        padding: 10px 30px;
        font-size: 16px;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 999;
    }

    .icono-chino {
        font-size: 48px;
        margin-bottom: 20px;
    }

    .exito .icono-chino {
        color: #27ae60;
    }

    .error .icono-chino {
        color: #e74c3c;
    }

    .titulo-seccion {
        font-size: 18px;
        font-weight: 600;
        color: #c0392b;
        margin-bottom: 15px;
        text-align: center;
    }

    .tooltip {
        position: absolute;
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1000;
    }

    .tooltip.show {
        opacity: 1;
    }
</style>
</head>
<body>

<div class="progreso">
<div class="progreso-texto" id="progresoTexto">L√≠nea de di√°logo 1 de 6</div>
</div>

<!-- Niveles para cada l√≠nea de di√°logo -->
<div id="nivel-0" class="nivel activo">
    <h2>Paso 1: Coloca el pinyin debajo de cada car√°cter</h2>
    <div class="traduccion">Traducci√≥n: "¬°Hola! ¬øC√≥mo te llamas?"</div>
    <div class="caracteres-container" id="caracteres-0"></div>
    <div class="pinyin-container" id="pinyin-0"></div>
    <div class="botones-control">
        <button class="btn-deshacer" onclick="deshacerUltimaAccion()" id="btnDeshacer" disabled>‚Ü∂ Deshacer</button>
        <button class="btn-secundario" onclick="reiniciarNivel()">üîÑ Reiniciar nivel</button>
        <button onclick="verificarPinyin(0)">Verificar pinyin</button>
    </div>
</div>

<!-- Paso 2: Ordenar frase -->
<div id="nivel-frase-0" class="nivel">
    <h2>Paso 2: Ordena la frase correctamente</h2>
    <div class="traduccion">Traducci√≥n: "¬°Hola! ¬øC√≥mo te llamas?"</div>
    <div class="caracteres-container" id="caracteres-desordenados-0"></div>
    <div class="zona-frase" id="zona-frase-0"></div>
    <div class="botones-control">
        <button class="btn-deshacer" onclick="deshacerUltimaAccion()" id="btnDeshacerFrase" disabled>‚Ü∂ Deshacer</button>
        <button class="btn-secundario" onclick="reiniciarNivel()">üîÑ Reiniciar nivel</button>
        <button onclick="verificarFrase(0)">Verificar frase</button>
    </div>
</div>

<!-- Nivel final: Ordenar di√°logo completo -->
<div id="nivel-dialogo" class="nivel">
    <h2>Paso Final: Ordena el di√°logo completo</h2>
    <div class="instruccion">Arrastra las frases de la izquierda a los espacios correctos de la derecha para formar una conversaci√≥n coherente. Haz clic en una frase ya colocada para devolverla.</div>
    
    <div class="dialogo-container">
        <div class="dialogo-frases">
            <div class="titulo-seccion">Frases disponibles</div>
            <div id="frases-disponibles"></div>
        </div>
        <div class="dialogo-orden">
            <div class="titulo-seccion">Orden del di√°logo</div>
            <div class="dialogo-slot" data-numero="1" data-indice="0"></div>
            <div class="dialogo-slot" data-numero="2" data-indice="1"></div>
            <div class="dialogo-slot" data-numero="3" data-indice="2"></div>
            <div class="dialogo-slot" data-numero="4" data-indice="3"></div>
            <div class="dialogo-slot" data-numero="5" data-indice="4"></div>
            <div class="dialogo-slot" data-numero="6" data-indice="5"></div>
        </div>
    </div>
    
    <div class="botones-control">
        <button class="btn-deshacer" onclick="deshacerUltimaAccion()" id="btnDeshacerDialogo" disabled>‚Ü∂ Deshacer</button>
        <button class="btn-secundario" onclick="reiniciarNivel()">üîÑ Reiniciar nivel</button>
        <button onclick="verificarDialogoFinal()">Verificar di√°logo completo</button>
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="mensaje-feedback" id="mensajeFeedback">
    <div class="icono-chino">üèÆ</div>
    <h3 id="tituloFeedback"></h3>
    <p id="textoFeedback"></p>
    <button onclick="cerrarFeedback()">Continuar</button>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
    let draggedItem = null;
    let lineaActual = 0;
    let frasesCompletadas = [];
    let ordenAleatorio = [];
    let caracteresUnicos = [];
    let historialAcciones = [];
    let nivelActivo = null;

    const dialogos = [
        {
            caracteres: ['‰Ω†', 'Â•Ω', 'ÔºÅ', '‰Ω†', 'Âè´', '‰ªÄ', '‰πà', 'Âêç', 'Â≠ó', 'Ôºü'],
            pinyin: ['n«ê', 'h«éo', '', 'n«ê', 'ji√†o', 'sh√©n', 'me', 'm√≠ng', 'zi', ''],
            traduccion: "¬°Hola! ¬øC√≥mo te llamas?",
            orden: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
        },
        {
            caracteres: ['Êàë', 'Âè´', 'ÂÆâ', 'Â®ú', 'Ôºå', '‰Ω†', 'Âë¢', 'Ôºü'],
            pinyin: ['w«í', 'ji√†o', 'ƒÅn', 'n√†', '', 'n«ê', 'ne', ''],
            traduccion: "Me llamo Anna, ¬øy t√∫?",
            orden: [0, 1, 2, 3, 4, 5, 6, 7]
        },
        {
            caracteres: ['Êàë', 'Âè´', 'È∫¶', 'ÂÖã', 'Ôºå', 'ËÆ§', 'ËØÜ', '‰Ω†', 'Âæà', 'È´ò', 'ÂÖ¥'],
            pinyin: ['w«í', 'ji√†o', 'm√†i', 'k√®', '', 'r√®n', 'shi', 'n«ê', 'hƒõn', 'gƒÅo', 'x√¨ng'],
            traduccion: "Me llamo Mike, mucho gusto en conocerte",
            orden: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        },
        {
            caracteres: ['Êàë', '‰πü', 'Âæà', 'È´ò', 'ÂÖ¥', 'Ôºå', '‰Ω†', 'ÊòØ', 'Â≠¶', 'Áîü', 'Âêó', 'Ôºü'],
            pinyin: ['w«í', 'yƒõ', 'hƒõn', 'gƒÅo', 'x√¨ng', '', 'n«ê', 'sh√¨', 'xu√©', 'shƒìng', 'ma', ''],
            traduccion: "Yo tambi√©n estoy muy contenta, ¬øeres estudiante?",
            orden: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
        },
        {
            caracteres: ['ÊòØ', 'Ôºå', 'Êàë', 'Â≠¶', '‰π†', 'Ê±â', 'ËØ≠', 'Ôºå', '‰Ω†', 'Âë¢', 'Ôºü'],
            pinyin: ['sh√¨', '', 'w«í', 'xu√©', 'x√≠', 'h√†n', 'y«î', '', 'n«ê', 'ne', ''],
            traduccion: "S√≠, estudio chino, ¬øy t√∫?",
            orden: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        },
        {
            caracteres: ['Êàë', '‰πü', 'ÊòØ', 'Ôºå', '‰πü', 'Â≠¶', '‰∏≠', 'Êñá'],
            pinyin: ['w«í', 'yƒõ', 'sh√¨', '', 'yƒõ', 'xu√©', 'zh≈çng', 'w√©n'],
            traduccion: "Yo tambi√©n, tambi√©n estudio chino",
            orden: [0, 1, 2, 3, 4, 5, 6, 7]
        }
    ];

    // Funci√≥n para guardar una acci√≥n en el historial
    function guardarAccion(tipo, datos) {
        historialAcciones.push({
            tipo: tipo,
            datos: datos,
            timestamp: Date.now()
        });
        actualizarBotonDeshacer();
    }

    // Funci√≥n para actualizar el estado del bot√≥n deshacer
    function actualizarBotonDeshacer() {
        const btnDeshacer = document.querySelector('.nivel.activo .btn-deshacer');
        if (btnDeshacer) {
            btnDeshacer.disabled = historialAcciones.length === 0;
        }
    }

    // Funci√≥n para deshacer la √∫ltima acci√≥n
    function deshacerUltimaAccion() {
        if (historialAcciones.length === 0) return;

        const ultimaAccion = historialAcciones.pop();
        
        switch(ultimaAccion.tipo) {
            case 'pinyin_colocado':
                const slot = document.querySelector(`.pinyin-slot[data-indice="${ultimaAccion.datos.indice}"]`);
                if (slot) {
                    slot.textContent = '';
                    slot.classList.remove('correcto');
                    // Mostrar el pinyin de nuevo
                    const pinyinElements = document.querySelectorAll('.pinyin');
                    pinyinElements.forEach(p => {
                        if (p.textContent === ultimaAccion.datos.pinyin) {
                            p.style.visibility = 'visible';
                            p.classList.remove('usado');
                        }
                    });
                }
                break;

            case 'caracter_colocado':
                const zonaFrase = document.querySelector(`#zona-frase-${ultimaAccion.datos.nivel}`);
                if (zonaFrase && zonaFrase.lastChild) {
                    zonaFrase.removeChild(zonaFrase.lastChild);
                }
                break;

            case 'dialogo_colocado':
                const dialogoSlot = document.querySelector(`.dialogo-slot[data-indice="${ultimaAccion.datos.slotIndice}"]`);
                if (dialogoSlot && dialogoSlot.children.length > 0) {
                    const item = dialogoSlot.children[0];
                    document.getElementById('frases-disponibles').appendChild(item);
                    dialogoSlot.classList.remove('lleno');
                    // Re-a√±adir eventos
                    item.classList.remove('en-slot');
                    inicializarEventoClickDialogo(item);
                }
                break;
        }

        actualizarBotonDeshacer();
    }

    // Funci√≥n para reiniciar el nivel actual
    function reiniciarNivel() {
        historialAcciones = [];
        actualizarBotonDeshacer();

        const nivelActual = document.querySelector('.nivel.activo');
        const nivelId = nivelActual.id;

        if (nivelId.startsWith('nivel-frase-')) {
            const indice = parseInt(nivelId.replace('nivel-frase-', ''));
            inicializarFrase(indice);
        } else if (nivelId === 'nivel-dialogo') {
            mostrarDialogoFinal();
        } else {
            const indice = parseInt(nivelId.replace('nivel-', ''));
            inicializarLinea(indice);
        }
    }

    // Generar orden aleatorio al inicio
    function generarOrdenAleatorio() {
        ordenAleatorio = Array.from({length: dialogos.length}, (_, i) => i);
        ordenAleatorio.sort(() => Math.random() - 0.5);
    }

    function obtenerIndiceActual() {
        return ordenAleatorio[lineaActual];
    }

    // Funci√≥n para obtener caracteres √∫nicos eliminando duplicados
    function obtenerCaracteresUnicos(caracteres) {
        const vistos = new Set();
        const unicos = [];
        
        caracteres.forEach((caracter, index) => {
            if (!vistos.has(caracter)) {
                vistos.add(caracter);
                unicos.push({
                    caracter: caracter,
                    indiceOriginal: index
                });
            }
        });
        
        return unicos;
    }

    function inicializarLinea(indice) {
        const dialogoIndex = obtenerIndiceActual();
        const dialogo = dialogos[dialogoIndex];
        const contenedorCaracteres = document.getElementById(`caracteres-${indice}`);
        const contenedorPinyin = document.getElementById(`pinyin-${indice}`);
        
        if (!contenedorCaracteres || !contenedorPinyin) {
            crearNivelesDialogo(indice);
            return;
        }

        contenedorCaracteres.innerHTML = '';
        contenedorPinyin.innerHTML = '';

        // Obtener caracteres √∫nicos
        caracteresUnicos = obtenerCaracteresUnicos(dialogo.caracteres);
        
        // Mezclar caracteres √∫nicos para mostrarlos en orden aleatorio
        const caracteresUnicosMezclados = [...caracteresUnicos].sort(() => Math.random() - 0.5);

        // Crear caracteres con slots de pinyin (sin duplicados)
        caracteresUnicosMezclados.forEach(item => {
            const box = document.createElement('div');
            box.className = 'caracter-box';
            
            const caracterDiv = document.createElement('div');
            caracterDiv.className = 'caracter';
            caracterDiv.textContent = item.caracter;
            
            const slot = document.createElement('div');
            if (dialogo.pinyin[item.indiceOriginal]) {
                slot.className = 'pinyin-slot';
                slot.dataset.pinyin = dialogo.pinyin[item.indiceOriginal];
                slot.dataset.indice = item.indiceOriginal;
                
                // A√±adir evento click para devolver pinyin
                slot.addEventListener('click', function() {
                    if (this.classList.contains('correcto')) {
                        const pinyin = this.textContent;
                        this.textContent = '';
                        this.classList.remove('correcto');
                        
                        // Mostrar el pinyin de nuevo
                        const pinyinElements = document.querySelectorAll('.pinyin');
                        pinyinElements.forEach(p => {
                            if (p.textContent === pinyin) {
                                p.style.visibility = 'visible';
                                p.classList.remove('usado');
                            }
                        });
                        
                        guardarAccion('pinyin_devuelto', {
                            indice: item.indiceOriginal,
                            pinyin: pinyin
                        });
                    }
                });
            }
            
            box.appendChild(caracterDiv);
            box.appendChild(slot);
            contenedorCaracteres.appendChild(box);
        });

        // Crear pinyin arrastrables (solo √∫nicos)
        const pinyinUnicos = new Set();
        dialogo.pinyin.forEach((p, i) => {
            if (p !== '') {
                pinyinUnicos.add(p);
            }
        });
        
        const pinyinMezclado = Array.from(pinyinUnicos).sort(() => Math.random() - 0.5);
        
        pinyinMezclado.forEach(pinyin => {
            const pinyinDiv = document.createElement('div');
            pinyinDiv.className = 'pinyin';
            pinyinDiv.draggable = true;
            pinyinDiv.textContent = pinyin;
            contenedorPinyin.appendChild(pinyinDiv);
        });

        // Actualizar progreso
        document.getElementById('progresoTexto').textContent = `L√≠nea de di√°logo ${lineaActual + 1} de ${dialogos.length}`;
        
        // Actualizar traducci√≥n
        const traduccionEl = document.querySelector(`#nivel-${indice} .traduccion`);
        if (traduccionEl) {
            traduccionEl.textContent = `Traducci√≥n: "${dialogo.traduccion}"`;
        }
        
        // Re-inicializar eventos de arrastre
        inicializarEventosArrastre();
    }

    function crearNivelesDialogo(indice) {
        const dialogoIndex = obtenerIndiceActual();
        const dialogo = dialogos[dialogoIndex];
        
        // Crear nivel de pinyin
        const nivelPinyin = document.createElement('div');
        nivelPinyin.id = `nivel-${indice}`;
        nivelPinyin.className = 'nivel';
        if (indice === 0) nivelPinyin.classList.add('activo');
        
        nivelPinyin.innerHTML = `
            <h2>Paso 1: Coloca el pinyin debajo de cada car√°cter</h2>
            <div class="traduccion">Traducci√≥n: "${dialogo.traduccion}"</div>
            <div class="caracteres-container" id="caracteres-${indice}"></div>
            <div class="pinyin-container" id="pinyin-${indice}"></div>
            <div class="botones-control">
                <button class="btn-deshacer" onclick="deshacerUltimaAccion()" disabled>‚Ü∂ Deshacer</button>
                <button class="btn-secundario" onclick="reiniciarNivel()">üîÑ Reiniciar nivel</button>
                <button onclick="verificarPinyin(${indice})">Verificar pinyin</button>
            </div>
        `;
        
        // Crear nivel de ordenar frase
        const nivelFrase = document.createElement('div');
        nivelFrase.id = `nivel-frase-${indice}`;
        nivelFrase.className = 'nivel';
        
        nivelFrase.innerHTML = `
            <h2>Paso 2: Ordena la frase correctamente</h2>
            <div class="traduccion">Traducci√≥n: "${dialogo.traduccion}"</div>
            <div class="caracteres-container" id="caracteres-desordenados-${indice}"></div>
            <div class="zona-frase" id="zona-frase-${indice}"></div>
            <div class="botones-control">
                <button class="btn-deshacer" onclick="deshacerUltimaAccion()" disabled>‚Ü∂ Deshacer</button>
                <button class="btn-secundario" onclick="reiniciarNivel()">üîÑ Reiniciar nivel</button>
                <button onclick="verificarFrase(${indice})">Verificar frase</button>
            </div>
        `;
        
        document.querySelector('#nivel-dialogo').before(nivelPinyin);
        document.querySelector('#nivel-dialogo').before(nivelFrase);
        
        inicializarLinea(indice);
    }

    function inicializarFrase(indice) {
        const dialogoIndex = obtenerIndiceActual();
        const dialogo = dialogos[dialogoIndex];
        const contenedorCaracteres = document.getElementById(`caracteres-desordenados-${indice}`);
        const zonaFrase = document.getElementById(`zona-frase-${indice}`);
        
        contenedorCaracteres.innerHTML = '';
        zonaFrase.innerHTML = '';

        // Actualizar traducci√≥n
        const traduccionEl = document.querySelector(`#nivel-frase-${indice} .traduccion`);
        if (traduccionEl) {
            traduccionEl.textContent = `Traducci√≥n: "${dialogo.traduccion}"`;
        }

        // Usar los caracteres √∫nicos para crear los elementos arrastrables
        const caracteresUnicosMezclados = [...caracteresUnicos].sort(() => Math.random() - 0.5);
        
        caracteresUnicosMezclados.forEach(item => {
            const div = document.createElement('div');
            div.className = 'caracter-completo';
            div.draggable = true;
            div.dataset.caracter = item.caracter;
            div.dataset.indiceOriginal = item.indiceOriginal;
            
            const hanzi = document.createElement('span');
            hanzi.className = 'hanzi';
            hanzi.textContent = item.caracter;
            
            div.appendChild(hanzi);
            
            if (dialogo.pinyin[item.indiceOriginal]) {
                const pinyin = document.createElement('span');
                pinyin.className = 'pinyin';
                pinyin.textContent = dialogo.pinyin[item.indiceOriginal];
                div.appendChild(pinyin);
            }
            
            contenedorCaracteres.appendChild(div);
        });

        inicializarEventosArrastre();
    }

    function inicializarEventosArrastre() {
        const elementos = document.querySelectorAll('[draggable="true"]');
        elementos.forEach(elemento => {
            elemento.removeEventListener('dragstart', handleDragStart);
            elemento.removeEventListener('dragend', handleDragEnd);
            elemento.addEventListener('dragstart', handleDragStart);
            elemento.addEventListener('dragend', handleDragEnd);
        });

        const pinyinSlots = document.querySelectorAll('.pinyin-slot');
        pinyinSlots.forEach(slot => {
            slot.removeEventListener('dragover', handleDragOver);
            slot.removeEventListener('drop', handleDrop);
            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('drop', handleDrop);
        });

        const zonasFrase = document.querySelectorAll('.zona-frase, .dialogo-slot');
        zonasFrase.forEach(zona => {
            zona.removeEventListener('dragover', handleDragOver);
            zona.removeEventListener('drop', handleDrop);
            zona.addEventListener('dragover', handleDragOver);
            zona.addEventListener('drop', handleDrop);
        });

        // A√±adir eventos de click para devolver elementos
        const caracteresEnZona = document.querySelectorAll('.zona-frase .caracter-completo');
        caracteresEnZona.forEach(caracter => {
            inicializarEventoClickCaracter(caracter);
        });

        const dialogosEnSlot = document.querySelectorAll('.dialogo-slot .dialogo-item');
        dialogosEnSlot.forEach(dialogo => {
            inicializarEventoClickDialogo(dialogo);
        });
    }

    function inicializarEventoClickCaracter(elemento) {
        elemento.classList.add('colocado');
        elemento.addEventListener('click', function() {
            const zonaFrase = this.parentElement;
            const nivel = zonaFrase.id.match(/\d+/)[0];
            const contenedorCaracteres = document.getElementById(`caracteres-desordenados-${nivel}`);
            
            // Remover del zona de frase
            zonaFrase.removeChild(this);
            
            // Quitar clase colocado
            this.classList.remove('colocado');
            
            guardarAccion('caracter_devuelto', {
                nivel: nivel,
                caracter: this.dataset.caracter
            });
        });
    }

    function inicializarEventoClickDialogo(elemento) {
        elemento.classList.add('en-slot');
        elemento.addEventListener('click', function() {
            if (this.classList.contains('en-slot')) {
                const slot = this.parentElement;
                const contenedorFrases = document.getElementById('frases-disponibles');
                
                // Devolver al contenedor de frases
                contenedorFrases.appendChild(this);
                slot.classList.remove('lleno');
                this.classList.remove('en-slot');
                
                guardarAccion('dialogo_devuelto', {
                    indice: this.dataset.indice
                });
                
                // Re-inicializar eventos
                inicializarEventosArrastre();
            }
        });
    }

    function handleDragStart(e) {
        draggedItem = e.target;
        e.target.style.opacity = '0.5';
    }

    function handleDragEnd(e) {
        e.target.style.opacity = '1';
    }

    function handleDragOver(e) {
        e.preventDefault();
    }

    function handleDrop(e) {
        e.preventDefault();
        const dropZone = e.target.closest('.pinyin-slot, .zona-frase, .dialogo-slot');
        
        if (!dropZone) return;

        if (dropZone.classList.contains('pinyin-slot')) {
            const pinyin = draggedItem.textContent;
            const correctPinyin = dropZone.dataset.pinyin;

            if (pinyin === correctPinyin && !dropZone.classList.contains('correcto')) {
                dropZone.textContent = pinyin;
                dropZone.classList.add('correcto');
                draggedItem.style.visibility = 'hidden';
                draggedItem.classList.add('usado');
                
                guardarAccion('pinyin_colocado', {
                    indice: dropZone.dataset.indice,
                    pinyin: pinyin
                });
            }
        } else if (dropZone.classList.contains('zona-frase')) {
            if (draggedItem.classList.contains('caracter-completo')) {
                const clon = draggedItem.cloneNode(true);
                dropZone.appendChild(clon);
                clon.addEventListener('dragstart', handleDragStart);
                clon.addEventListener('dragend', handleDragEnd);
                inicializarEventoClickCaracter(clon);
                
                const nivel = dropZone.id.match(/\d+/)[0];
                guardarAccion('caracter_colocado', {
                    nivel: nivel,
                    caracter: draggedItem.dataset.caracter
                });
            }
        } else if (dropZone.classList.contains('dialogo-slot')) {
            // Si ya hay algo en el slot, devolverlo
            if (dropZone.children.length > 0) {
                const existente = dropZone.children[0];
                document.getElementById('frases-disponibles').appendChild(existente);
                existente.classList.remove('en-slot');
            }
            
            dropZone.innerHTML = '';
            dropZone.appendChild(draggedItem);
            dropZone.classList.add('lleno');
            inicializarEventoClickDialogo(draggedItem);
            
            guardarAccion('dialogo_colocado', {
                slotIndice: dropZone.dataset.indice,
                dialogoIndice: draggedItem.dataset.indice
            });
        }
    }

    function verificarPinyin(indice) {
        const slots = document.querySelectorAll(`#nivel-${indice} .pinyin-slot`);
        const todosCorrectos = Array.from(slots).every(slot => slot.classList.contains('correcto'));
        
        if (todosCorrectos) {
            mostrarFeedback(
                '¬°Excelente! Â§™Â•Ω‰∫Ü!',
                'Has colocado todos los pinyin correctamente. Ahora ordena la frase.',
                true,
                function() {
                    historialAcciones = [];
                    document.getElementById(`nivel-${indice}`).classList.remove('activo');
                    document.getElementById(`nivel-frase-${indice}`).classList.add('activo');
                    inicializarFrase(indice);
                }
            );
        } else {
            mostrarFeedback(
                '¬°Int√©ntalo de nuevo! ÂÜçËØï‰∏ÄÊ¨°!',
                'Por favor, coloca todos los pinyin correctamente antes de continuar.',
                false
            );
        }
    }

    function verificarFrase(indice) {
        const dialogoIndex = obtenerIndiceActual();
        const dialogo = dialogos[dialogoIndex];
        const zonaFrase = document.querySelector(`#zona-frase-${indice}`);
        const caracteresEnOrden = Array.from(zonaFrase.children)
            .map(elem => elem.querySelector('.hanzi').textContent);
        
        // Verificar que los caracteres coincidan con la frase original
        const fraseCorrecta = dialogo.caracteres.join('');
        const fraseUsuario = caracteresEnOrden.join('');
        
        if (fraseUsuario === fraseCorrecta) {
            frasesCompletadas.push({
                texto: fraseCorrecta,
                traduccion: dialogo.traduccion,
                indice: dialogoIndex
            });

            if (lineaActual < dialogos.length - 1) {
                mostrarFeedback(
                    '¬°Muy bien! ÂæàÂ•Ω!',
                    'Has ordenado la frase correctamente. Pasemos a la siguiente l√≠nea de di√°logo.',
                    true,
                    function() {
                        historialAcciones = [];
                        document.getElementById(`nivel-frase-${indice}`).classList.remove('activo');
                        lineaActual++;
                        const siguienteIndice = lineaActual;
                        if (!document.getElementById(`nivel-${siguienteIndice}`)) {
                            crearNivelesDialogo(siguienteIndice);
                        }
                        document.getElementById(`nivel-${siguienteIndice}`).classList.add('activo');
                        inicializarLinea(siguienteIndice);
                    }
                );
            } else {
                mostrarFeedback(
                    '¬°Excelente! ÈùûÂ∏∏Â•Ω!',
                    'Has completado todas las l√≠neas. Ahora ordena el di√°logo completo.',
                    true,
                    function() {
                        historialAcciones = [];
                        document.getElementById(`nivel-frase-${indice}`).classList.remove('activo');
                        mostrarDialogoFinal();
                    }
                );
            }
        } else {
            mostrarFeedback(
                '¬°Casi lo logras! Âä†Ê≤π!',
                'El orden de la frase no es correcto. Int√©ntalo de nuevo.',
                false
            );
        }
    }

    function mostrarDialogoFinal() {
        document.getElementById('nivel-dialogo').classList.add('activo');
        const contenedorFrases = document.getElementById('frases-disponibles');
        contenedorFrases.innerHTML = '';

        // Limpiar slots
        const slots = document.querySelectorAll('.dialogo-slot');
        slots.forEach(slot => {
            slot.innerHTML = '';
            slot.classList.remove('lleno');
        });

        // Mezclar las frases completadas
        const frasesMezcladas = [...frasesCompletadas].sort(() => Math.random() - 0.5);

        frasesMezcladas.forEach(frase => {
            const item = document.createElement('div');
            item.className = 'dialogo-item';
            item.draggable = true;
            item.dataset.indice = frase.indice;
            
            const texto = document.createElement('div');
            texto.className = 'dialogo-texto';
            texto.textContent = frase.texto;
            
            const traduccion = document.createElement('div');
            traduccion.className = 'dialogo-traduccion';
            traduccion.textContent = frase.traduccion;
            
            item.appendChild(texto);
            item.appendChild(traduccion);
            contenedorFrases.appendChild(item);
        });

        inicializarEventosArrastre();
    }

    function verificarDialogoFinal() {
        const slots = document.querySelectorAll('.dialogo-slot');
        let todosLlenos = true;
        let ordenCorrecto = true;

        slots.forEach((slot, index) => {
            if (slot.children.length === 0) {
                todosLlenos = false;
            } else {
                const item = slot.children[0];
                const indiceItem = parseInt(item.dataset.indice);
                if (indiceItem !== index) {
                    ordenCorrecto = false;
                }
            }
        });

        if (!todosLlenos) {
            mostrarFeedback(
                '¬°Faltan frases! ËøòÂ∑Æ‰∏Ä‰∫õ!',
                'Por favor, coloca todas las frases en los espacios correspondientes.',
                false
            );
        } else if (ordenCorrecto) {
            mostrarFeedback(
                '¬°Felicitaciones! ÊÅ≠ÂñúÊÅ≠Âñú!',
                'Has completado exitosamente todo el ejercicio. ¬°Excelente trabajo con la conversaci√≥n en chino!',
                true
            );
        } else {
            mostrarFeedback(
                '¬°Intenta de nuevo! ÂÜçËØï‰∏ÄÊ¨°!',
                'El orden del di√°logo no es correcto. Piensa en c√≥mo fluir√≠a naturalmente la conversaci√≥n.',
                false
            );
        }
    }

    function mostrarFeedback(titulo, texto, esExito, callback) {
        const overlay = document.getElementById('overlay');
        const mensaje = document.getElementById('mensajeFeedback');
        const tituloEl = document.getElementById('tituloFeedback');
        const textoEl = document.getElementById('textoFeedback');
        const icono = mensaje.querySelector('.icono-chino');
        
        tituloEl.textContent = titulo;
        textoEl.textContent = texto;
        
        if (esExito) {
            mensaje.classList.add('exito');
            mensaje.classList.remove('error');
            icono.textContent = 'üéä';
        } else {
            mensaje.classList.remove('exito');
            mensaje.classList.add('error');
            icono.textContent = 'üèÆ';
        }
        
        overlay.style.display = 'block';
        mensaje.style.display = 'block';
        
        if (callback) {
            window.feedbackCallback = callback;
        }
    }

    function cerrarFeedback() {
        const overlay = document.getElementById('overlay');
        const mensaje = document.getElementById('mensajeFeedback');
        
        overlay.style.display = 'none';
        mensaje.style.display = 'none';
        
        if (window.feedbackCallback) {
            window.feedbackCallback();
            window.feedbackCallback = null;
        }
    }

    // Inicializar la primera l√≠nea
    document.addEventListener('DOMContentLoaded', function() {
        generarOrdenAleatorio();
        inicializarLinea(0);
    });
</script>
</body>
</html>